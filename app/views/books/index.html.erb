<style>
	.mouse-on{
		height:auto !importan;
		border-color: #66afe9;
		box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075), 0 0 8px rgba(102, 175, 233, 0.6);
		
	}
	.supplemental-info{
		background: #f8f8f8;
		//margin: 15px 0 0;
		padding: 10px;
		margin-top: 12px;
		border-top: 1px solid #ccc;
		margin-left: -4px;
		margin-right: -4px;
		cursor :default;
	}
</style>
<br>

<div class="container">
	<%= search_form_for @q, url:"/books/", class:"form-inline" do |f| %>
		<div class="row">	
			<div class="col-md-12 text-center">
				<%=link_to "新增商品",new_book_path,class:"btn btn-info",style:"font-size:16px;" %>
				<% if current_user&&current_user.book_trade_infos.count>0 %>
				<%=link_to "我的商品","/books/?mine=true",class:"btn btn-success",style:"font-size:16px;" %>
				<% end %>
				<div class="input-group" >
					<%=text_field_tag :q,params[:q], class: "form-control", placeholder:"書名/作者/課名",style:"width:350px;" %>
					<span class="input-group-btn">			
						<button type="submit" class="btn btn-primary" id="search"><%=fa_icon "search"%></button>        
					</span><!-- /btn-group -->
				</div><!-- /input-group -->
				<!--
				<div class="checkbox">
					<label style="font-size:16px;">
						<%=check_box_tag "adv_toggle",params[:adv_toggle],params[:adv_toggle],onchange: "$('#adv-search').toggleClass('hidden');" %>
						進階搜尋
					</label>
				</div>
				-->
			</div>
		</div>
	<% end %>
  <div id="products" class="row">
		<%@sale_books.each do |sale_book| %>
			<div class="col-md-4 col-sm-6">
				<div id="book-<%=sale_book.id%>" href="/books/<%=sale_book.id%>" class="thumbnail clickable-hover" style="height:293px; margin-top:30px;" onmouseover="$(this).addClass('mouse-on')" onmouseleave="$(this).removeClass('mouse-on')" onclick="goToHref($(this).attr('href'),true);">					
					<div id="control-bar" style="width:100%;position: absolute;" onmouseover="$(this).parent().attr('onclick','')" onmouseleave="$(this).parent().attr('onclick','goToHref($(this).attr(\'href\'));')">
						<% if sale_book.user==current_user && sale_book.status==0%>
							<%=link_to fa_icon("pencil"), edit_book_path(sale_book),class:"btn btn-sm btn-info" %>
							<%=button_tag fa_icon("check"), class:"btn btn-sm btn-info",onclick:"setBookSaled(#{sale_book.id});" %>
						<% end %>
					</div>
					<%=sale_book.cover_image%>

						<%=image_tag asset_path("soldout.png"),class:sale_book.status==0 ? "hidden":"",style:"position:absolute;z-index:10;top: 24px;left: 8px;"%>

					<div style="min-height:50px;margin-top:3px;padding-left:4px;" >
						<div class="text-center" >
							<span style="font-size:14px;">
								<strong data-toggle="tooltip" title="<%=sale_book.book_name%>" >
									<%=sale_book.book_name.truncate(15)%>					
								</strong><br>
								<strong data-toggle="tooltip" title="<%=sale_book.book.authors%>">
									作者:<%=sale_book.book.authors.truncate(15)%>
								</strong><br>
							</span>
							<span data-toggle="tooltip" style="margin-top:3px;/*margin-bottom: 13px;*/" title="
								<% if sale_book.course_teacherships.present?%>
								<% sale_book.course_teacherships.each do |cts|%>
									<%="#{cts.course_ch_name} #{cts.teacher_name}" %><br>
								<% end %>
								<% else %>
									無
								<% end %>
								">
								<%="課程:#{sale_book.course_teacherships.first.try(:course_ch_name)} 老師:#{sale_book.course_teacherships.first.try(:teacher_name)}".truncate(15) %><br>
							</span>

						</div>
						

					</div>
					<div class="supplemental-info" onmouseover="$(this).parent().attr('onclick','')" onmouseleave="$(this).parent().attr('onclick','goToHref($(this).attr(\'href\'));')">
						<% user=sale_book.user %>
						<font color="#696969">
							賣家:<%=user.name%>
							<%=sale_book.created_at.strftime("%m/%d %H:%M")%>
						</font>
						
						<strong class="pull-right" style="font-size:20px;margin-top:-5px;">
							<%=fa_icon "dollar" %> <%=sale_book.price%>
						</strong>
					</div>						
				</div>
			</div>
		<% end %>
		
	</div>
	<%= paginate @sale_books, :window=>2 %>
</div>
<script>
	$(function () {
		$("[data-toggle='tooltip']").tooltip({
				content: function () {
						return $(this).prop('title');
				},
				position: { my: "left-20 top+20"}
		});
	});
	function setBookSaled(id){
		if(!confirm("您確定將此本書設為已售出嗎?(設定完不可再做變更)"))
			return false;
		$.ajax({
			type:"PATCH",
			url:"/books/"+id,
			data:{
				"book_trade_info[status]":1
			},
			success:function(){
				$("#book-"+id).find("#control-bar").remove();
				$("#book-"+id).find("img.hidden").removeClass("hidden");
			}
			
		});
		
	}
</script>
