
<% page = CourseContentHead.where(:course_teachership_id => @ct.id).first.presence || nil%>

<!-- course's teacher and department -->
<h2 style="border-bottom:solid 1px;">課程資訊</h2>
	<div class="panel-heading">
		<h2 class="panel-title">
			<h4>
				永久課號: <%=@course.real_id%>
				學分: <%=@course.credit%>
				<% if @cds.last.semester_id!=latest_semester.id%>
					(本學期無開課)
				<% end %>
				查看更多 
				<%=link_to("javascript:void(0);", :class=>"see-more-course") do%>
					
					<%=fa_icon "search-plus"%>
				<% end %>
			</h4>
			<table class="table">
				<tr>
    			<td><%=fa_icon "calendar-o" %> 學期</td>
					<td><%=fa_icon "bank" %> 單位</td>
					<td><%=fa_icon "pencil" %> 課號</td>
					<td><%=fa_icon "book" %> 選別</td>
					<td><%=fa_icon "bell" %> 時間</td>
    			<td><%=fa_icon "building" %> 教室</td>
    			<td><%=fa_icon "tag" %> 年級</td>					
    			<td class="col-md-4"><%=fa_icon "bookmark" %> 備註</td>
    		</tr>
				<% @cds.order("semester_id DESC").select{|cd| cd.semester==latest_semester}.each do |cd| %>  
					<tr>
						<td><%=cd.semester.name%></td>
						<td><%=cd.department.ch_name%></td>
						<td><%=link_to cd.temp_cos_id,"https://cos.adm.nctu.edu.tw/Course/CrsOutline/show.asp?Acy=#{cd.semester.year}&Sem=#{cd.semester.half}&CrsNo=#{cd.temp_cos_id}", target:"_blank"%></td>
						<td>
							<%=cd.cos_type%>
							<% if cd.cos_type=="通識"%>
								(<%=cd.brief%>)
							<% end %>
						</td>
						<td><%=cd.time%></td>
						<td><%=cd.room%></td>
						<td><%= cd.grade=='*' ? 'all' : cd.grade %></td>						
						<td><%=cd.memo%></td>
					</tr>    
				<%end%>
				<% @cds.order("semester_id DESC").reject{|cd| cd.semester==latest_semester}.each do |cd| %>  
					<tr class="old-course">
						<td><%=cd.semester.name%></td>
						<td><%=cd.department.ch_name%></td>
						<td><%=link_to cd.temp_cos_id,"https://cos.adm.nctu.edu.tw/Course/CrsOutline/show.asp?Acy=#{cd.semester.year}&Sem=#{cd.semester.half}&CrsNo=#{cd.temp_cos_id}", target:"_blank"%></td>
						<td>
							<%=cd.cos_type%>
							<% if cd.cos_type=="通識"%>
								(<%=cd.brief%>)
							<% end %>
						</td>
						<td><%=cd.time%></td>
						<td><%=cd.room%></td>
						<td><%= cd.grade=='*' ? 'all' : cd.grade %></td>						
						<td><%=cd.memo%></td>
					</tr>    
				<%end%>
			</table>
			
		</h2>	
	</div>
 
<!-- statistics -->  
   <div id="reg_nums" class="panel-heading">
		<h2 class="panel-title">
			<p id="statistics-header">
				<i class="fa fa-align-left"></i>				
				歷年統計：
			</p>	
		</h2>	
	</div>
	<div id="container" style="height: 400px; width: 800px;"></div></br>
	<div id="container-score" style="height: 400px; width: 800px;"></div>
<!-- course's content and tick -->    
    <div id="course-tips" class="panel-heading">
		<h2 class="panel-title">
			<p>
				<i class="fa fa-gamepad"></i>				
				課程攻略：
			</p>
		</h2>	
	</div>
	<div class="panel-body">
		<div class="well">
			<div class="row" >
			<i class="fa fa-cube"></i> 作業/考試：
			<%if not current_user%>
				<%=link_to "編輯", "javascript:void(0);", :onclick=>"alert('請先登入謝謝');", :id=>"link_edit_head"%>	
			<% elsif not current_user.uid.presence %>
				<%=link_to "編輯", "javascript:void(0);", :onclick=>"alert('須綁定FB才可編輯');", :id=>"link_edit_head"%>	
			<% else %>
				<%=link_to "編輯", "javascript:void(0);", :onclick=>"loadForm("+@ct.id.to_s+",$(this),'head');", :id=>"link_edit_head"%>	
			<% end %>
			<span id="toggle-msg-head" style="display:none;"></span>
			</br></br>
				<div id="course_content_head">
					<%=loading_img%>
				</div>
			</div>
			<div class="row" id="head_form"></div>
			<hr>
			<div class="row">
			<i class="fa fa-cube"></i> 其他內容：
			<%if not current_user%>
				<%=link_to "編輯", "javascript:void(0);", :onclick=>"alert('請先登入謝謝');", :id=>"link_edit_head"%>	
			<% elsif not current_user.uid.presence %>
				<%=link_to "編輯", "javascript:void(0);", :onclick=>"alert('須綁定FB才可編輯');", :id=>"link_edit_head"%>	
			<% else %>
				<%=link_to "編輯", "javascript:void(0);", :onclick=>"loadForm("+@ct.id.to_s+",$(this),'list');", :id=>"link_edit_head"%>
			<% end %>
			
			<span id="toggle-msg-list" style="display:none;"></span>
			</br></br>
				<div id="course_content_list">
					<%=loading_img%>
				</div>
			</div>
			<div class="row" id="list_form"></div>
		</div>
		
	</div>

<!-- comment for the info in this page -->
	<div id="messages" class="panel-heading">
		<h2 class="panel-title">
			<p>
				<i class="fa fa-weixin"></i>			
				留言板： 
		<% if not current_user %>
			<%=link_to "留言", "javascript:void(0);", :onclick=>"alert('請先登入謝謝');", :id=>"comment_post_link"%>		
		<% elsif current_user.uid %>
				<div id="commentNew">	
			<%=form_tag "/courses/comment_submit", :remote=>true, :class=>"form-horizontal",:role=>"form" do%>
					<%=hidden_field_tag "ctship", @ct.id %>
					<div class="form-group">
						<div class="col-sm-1 col-md-offset-1">
							<select id="type" name="type" class="form-control">
								<option value="1">推</option>
								<option value="2">-></option>
								<option value="3">噓</option>
							</select>
						</div>				
						<div class="col-sm-7">
							<div class="input-group" id="comment-group">
								<input class="form-control" id="comment" name="comment" type="text" value="推薦這門課程">
      							<span class="input-group-btn">
      								<%=submit_tag "POST", :class=>"btn btn-primary", :id=>"submit_but", :onclick=>"return checkComment();"%> 
      							</span>
   							</div>
						</div>
					</div>	
			<%end%>
				</div>	
		<% else %>
				<%=link_to "留言", "javascript:void(0);", :onclick=>"alert('須綁定FB才可編輯');", :id=>"comment_post_link"%>		
		<% end %> <!-- current_user -->
			</p>	
		</h2>	
	</div>
	
	<div class="panel-body">				
		<div class="well backgorund-color-grey " id="commentList">
				<%=render :partial=>"comment_list", :locals => {:ct_id=>@ct.id} %>
		</div>
	</div>
	
<!-- </div> -->

<script>
	
	$(document).ready(function(){	
	
		$.ajax({
			type: "GET",
			dataType: "script",
			url: '/course_content/raider?ct_id=<%=j @ct.id.to_s %>&type=5',
			error: function(res){
				alert("Some error happened in chart :( ");
			}
  	});		

	  $('#course_content_head').load('/course_content/raider?ct_id=<%=j @ct.id.to_s %>&type=1') ;
		$('#course_content_list').load('/course_content/raider?ct_id=<%=j @ct.id.to_s %>&type=2') ;
		$('#head_form').hide() ;
		$('#head_list').hide() ;
	
		$('.old-course').hide();
		$('.see-more-course').click(function(){
			$('.old-course').toggle();
			$(this).find('.fa').toggleClass("fa-search-minus");
		});
	});
	
	
	
	function checkComment(){
		if(!confirm("確定資料無誤嗎？"))
			return false ;
		var isEmpty = ($('#comment').val().length==0)?true:false ;
		if(isEmpty){
			$('#comment-group').addClass('has-error');
		}
		return !isEmpty ;
	}
	
	function loadForm(id, link, type){
		var get_type = 3 ; 
		if(type=="list")
			get_type = 4 ;	

		if(link.html()=="編輯"){
			link.html("收回");
			$('#'+type+'_form').load("/courses/course_raider?ct_id="+id+"&type="+get_type);
			$('#'+type+'_form').show() ;
			$('#course_content_'+type).hide() ;
		}else{
			link.html("編輯");
			$('#course_content_'+type).load('/courses/course_raider?ct_id=<%=j @ct.id.to_s %>&type='+(get_type-2)) ;
			$('#'+type+'_form').html('').hide() ;
			$('#course_content_'+type).show() ;
		}	
	}
	
	function commentShow(link){
		
		if(link.html()=="留言"){
			$('#comment-group').removeClass('has-error');
			$("#commentNew").show();
			link.html("收回");
		}else{
			$("#commentNew").hide();
			link.html("留言");
		}				
	}
		
	function PMchange(myclass){
		if(myclass)
			$('#imagePM').switchClass('fa-search-plus','fa-search-minus');				
		else	
			$('#imagePM').switchClass('fa-search-minus','fa-search-plus');				
			
	}
<%if current_user%>	
	function changeColor(but,color,type){		
		if(but.hasClass('active')){
			but.removeClass('active').switchClass('btn-'+color, 'btn-default') ;
			but.attr('id','') ;
		}else{			
			but.addClass('active').switchClass('btn-default', 'btn-'+color) ;
			but.attr('id','1') ;
		}
	}
	
	function headSubmit(){
		if(!confirm("確定資料無誤嗎？"))
			return false ;

		var test= 0 ;
		var hw=0 ;
		$('#test-btn-group > button').each(function( index ) {			
  			if($(this).attr('id')=='1')
  				test = test | Math.pow(2,index) ;		
		});
		$('#hw-btn-group > button').each(function( index ) {			
  			if($(this).attr('id')=='1')
  				hw = hw | Math.pow(2,index) ;	
		});

	//alert(test) ; alert(hw);
		$.ajax({
			type: "POST",
			dataType: "script",
  			url: "/courses/course_content_post" ,
  			data:{
  				post_type: 0,
  				test: test,
  				hw: hw,
  				rollcall: $("#rollcall").val(),
  				ct_id : <%=j @ct.id.to_s %>
  			},
  			success: function(){
  				$('#toggle-msg-head').addClass('text-color-green').html('更新成功').show().fadeOut(3000);
  			}
		});
		
		
		return false ;
	}

	function preferClick(pre, id){
		var str ="" ;
		if(pre==1)
			str = "你覺得這則內容有價值？\n[給評後不能反悔請注意]" ;
		else
			str = "你覺得這是則廢文？\n[給評後不能反悔請注意] " ;
			
		if(!confirm(str))
			return false ;
		
		$.ajax({
			type: "GET",
			dataType: "script",
  			url: "/course_content/raider_list_like" ,
  			data:{
  				like_type: pre ,
  				list_id : id 
  			},	
  			success: function(){
  				$('#toggle-msg-list').addClass('text-color-green').html('給評成功').show().fadeOut(3000);
  			}
  		});			
			
	}
	
	function EditOld(thistd){
		var id = thistd.parent('tr').attr('id').substring(17) ;
		var content = "" ;
		var list_type = thistd.parent('tr').find('td').first().html(); 
		var type_id = 1 ;
		switch(list_type) {
    		case "[考試]":
    			type_id=1;
    			break ;
    		case "[作業]":
    			type_id=2;
    			break ;
    		case "[上課]":
    			type_id=3;
    			break ;
    		case "[其他]":
    			type_id=4;
    			break ;
		}
		//alert(type_id);
		content = thistd.parent('tr').find('span').first().html();	
		thistd.parent('tr').children().hide() ;
		thistd.parent('tr').append(
			'<td>'+
			'<select class="form-control" id="type_old'+id+'" name="type_old'+id+'">'+
			'<option value="1">[考試]</option>'+
			'<option value="2">[作業]</option>'+
			'<option value="3">[上課]</option>'+
			'<option value="4">[其他]</option>'+
			'</select></td>'+
			'<td><span class="col-sm-10"><input class="form-control" id="list_old'+id+'" name="list_old'+id+'" type="text" value="'+content+'"></span>'+
			'<span class="col-sm-2">'+
			'<div class="btn btn-success btn-circle" name="button" onclick="return Submit($(this));"><i class="fa fa-check"></i></div> '+
			'<div class="btn btn-danger btn-circle" name="button" onclick="return Cancel($(this));"><i class="fa fa-times"></i></div>'+
			'</span>'+
			'</td>'
		);
		$("#type_old"+id+" option[value='"+type_id+"']").attr('selected', 'selected');
		return false ;
	}
	
	function Del(thisdiv){
		if(!confirm("確定要刪除嗎？"))
			return false ;
		var tr = thisdiv.parent('span').parent('td').parent('tr') ;
		var ctid = <%=j @ct.id.to_s %> ;
		$.ajax({
			type: "POST",
			dataType: "script",
  			url: "/courses/course_content_post" ,
  			data:{
  				post_type: 1,
  				id: tr.attr('id') ,
  				del: 1,
  				ct_id : ctid
  			},
  			success: function(){
  				$('#toggle-msg-list').addClass('text-color-green').html('刪除成功').show().fadeOut(3000);
  				$('#list_form').load("/course_content/raider?ct_id="+ctid+"&type=4");
  			}
		});
		
		return false ;
	}

	function Submit(tdiv){
		if(!confirm("確定資料無誤嗎？"))
			return false ;

		var tr = tdiv.parent('span').parent('td').parent('tr');
		var id = tr.attr('id');//.substring(17) ;
		var ctid = <%=j @ct.id.to_s %> ;
		if(tr.find('input').val()==""){
			alert("內容不可留白謝謝");
			return false ;
		}
		$.ajax({
			type: "POST",
			dataType: "script",
  			url: "/courses/course_content_post" ,
  			data:{
  				post_type: 1,
  				id: id ,
  				content_type: tr.find('select').val(),
  				content: tr.find('input').val(),
  				ct_id : ctid
  			},
  			success: function(){
  				$('#toggle-msg-list').addClass('text-color-green').html('更新成功').show().fadeOut(4000);
  				$('#list_form').load("/course_content/raider?ct_id="+ctid+"&type=4");
  			}
		});
		
		return false ;
	}
	
	function Cancel(tdiv){
		var tr = tdiv.parent('span').parent('td').parent('tr');
		tr.children().each(function(index){
			if($(this).css('display')=='none')
				$(this).show();
			else
				$(this).remove() ;	
		});
		return false ;
	}
	
<% end %>	

	
</script>