<%= javascript_include_tag "user_course_stat/checker", "data-turbolinks-track" => true %>
<div class="row" style="">
	<div class="col-md-5 col-md-offset-1">
		<div class="panel panel-primary ">
			<div class="panel-heading">
				<h4 class="text-center">
					<button id="has-select-btn" class="btn btn-circle btn-info pull-left" onclick="show_has_select()" style="margin-top: -5px;">
						<font color="white"><%=fa_icon "check"%></font>
					</button>	
					課程查詢
					<button id="suggest-btn" class="btn btn-circle btn-success pull-righ" onclick="showSearch();" style="margin-top: -5px;">
						<font color="white"><%=fa_icon "search" %></font>
					</button>
				</h4>
			</div>
			<div class="panel-body">
				<%= render "suggest_btns" %>
				<div id="search_div" class="row schedule-search-bar"></div>
			</div>
		</div>
	</div>
	<div class="col-md-6 " id="schedule_div">
		<div class="panel panel-primary ">
			<div class="panel-heading" style="background-color:#4c66a4;">
				<h4 class="text-center">
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
					<%= Semester::LAST.year.to_s + ((Semester::LAST.half==1) ? "上" : "下") %>
					<a href="/courses/export_timetable.xls?sem_id=<%=Semester::LAST.id%>" id="download-link" class="btn btn-success btn-circle pull-right" style="margin-top: -5px;">
						<i class="fa fa-download"></i>
					</a>
				</h4>		
			</div>
			<table class="table table-bordered" id="schedule_table"></table>
		</div>	
	</div>
	
</div>

<script>
	$(document).ready(function(){
		$('#has-select-btn').popover({
			content: "已選課程",
			placement:"auto",
			trigger : "hover",
			container :"body"
		});	
		$(".btn-default").popover({
				//content : $(this).attr('tiptext'),
				trigger :"hover",
				container :"body",
				placement : "auto"
		});

		//sidebar search
		$("#search_div").load("/courses/search_mini?sem_id=<%=Semester::LAST.id%>",function(){
			show_has_select();
		});		
		
		//course table
		load_course_table(<%=Semester::LAST.id%>, true);
		
		sessionTest();
		
	});
	
	function showSearch(){
		$("#search_div").find('form').toggleClass("hidden");
	}
	function searchLackCourses(){
		<% if current_user.is_undergrad? %>
			$(".scrollable").html("<%=j loadingImg%>");
			$.getJSON("/user/get_courses?uid=<%=params[:uid]%>&type=stat", function (data) {
				console.log(data);
				var result=commonCheck(data.pass_score,data.taked);
				var arr="[";
				for(var dimension in result['common']){
					if (result['common'][dimension]==0){ 
						arr+='"'+dimension+'",';
						console.log(arr);
					}
				}
				if(arr.length==1)
					toastr["info"]("你已經修完了喔^_^");
				else{
					arr=arr.substr(0,arr.length-1);
					arr+=']';					
					$("#dimension_search").val(arr);
					$("form").submit();
				}
			});
		<% else %>
			toastr["info"]("你不需要修通識喔^_^");
		<% end %>
	}
	
	function load_course_table(semester_id, selectable){
		$.getJSON("/user/get_courses?type=course_table&sem_id="+semester_id,function(data){
			//console.log(data);
			data.config = {
				deletable: true ,
				selectable: true,
				popover: true,
				cancelButtonFunc: function(arg){
					var cd_id = arg.data.cd_id;
					save_course(cd_id,'delete','load_course_table');
				}
			};
			$('#schedule_table').CourseTable(data);	
		});
	}
	function show_has_select(){
		$.getJSON("/user/get_courses?type=simulation",function(data){
			//console.log(data);
			$(".scrollable").html(tmpl("search_result", data));
		});
	}

	function show_cart(){
		$("#search_div").load("/course_details/mini?sem_id=<%=@sem_id%>");
	}

	function get_selected_time_slot(){
		var selected = $('#schedule_table').CourseTable('getSelectedSlot');
		if(selected.length>0){
			var arr_str = '[';
			for(var i=0, ele;ele=selected[i]; ++i)
				arr_str+= '"'+ele+'",';
			arr_str=arr_str.substr(0,arr_str.length-1);
			arr_str+=']';
			$('#timeslot_search').val(arr_str);
			$(".scrollable").html("<%=j loadingImg%>");
			$("form").submit();
		}
		else
			toastr["warning"]("請先在右方課表選取時間");
	}
</script>

<%=render "courses/search/xtmpl_results_mini"%>
