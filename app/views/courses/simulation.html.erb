<%= javascript_include_tag "user_course_stat/checker", "data-turbolinks-track" => true %>
<%= javascript_include_tag "courses/simulation", "data-turbolinks-track" => true %>

<div class="row" style="">
	<div class="col-md-5 col-md-offset-1">
		<div class="panel panel-primary ">
			<div class="panel-heading">
				<h4 class="text-center">
					<button id="has-select-btn" class="btn btn-circle btn-info pull-left pop-over" data-content="已選課程" onclick="showHasSelected()" style="margin-top: -5px;">
						<font color="white"><%=fa_icon "check"%></font>
					</button>	
					課程查詢
					<button id="shopping-cart" class="btn btn-circle btn-info pull-right pop-over" data-content="收藏課程" onclick="$('.scrollable').load('/courses/show_cart?view_type=simulation&use_type=add');" style="margin-top: -5px;">
						<font color="white"><%=fa_icon "star"%></font>
					</button>	
				</h4>
			</div>
			<div class="panel-body">
				<%= render "suggest_btns" %>
				<div id="search_div" class="row schedule-search-bar">
					<%= render "/courses/search/mini_form" %>
					<div class="scrollable"></div>
				</div>
			</div>
		</div>
	</div>
	<div class="col-md-6 " id="schedule_div">
		<div class="panel panel-primary ">
			<div class="panel-heading" style="background-color:#4c66a4;">
				<h4 class="text-center">
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
					<%= Semester::LAST.year.to_s + ((Semester::LAST.half==1) ? "上" : "下") %>


          
					<div class="btn-group pull-right header-button">
						<button type="button" class="btn btn-circle btn-success dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
							 <i class="fa fa-download"></i>
						</button>
						<ul class="dropdown-menu" role="menu">
							<li><a href="/courses/export_timetable.xls?sem_id=<%=Semester::LAST.id%>">Excel</a></li>
							<li><a href="#" onclick="$('#schedule_table').CourseTable('renderImg', 'window');">Image</a></li>
						</ul>
					</div>
					<% if current_user.canShare? %>
					<button type="button" id="copy-it-simu" 
					  class="btn btn-circle btn-warning pull-right header-button" 
					  style="margin-right: 5px ;"
					  data-content="複製分享連結" 
					  data-clipboard-text="<%=root_url %>shares/<%=current_user.get_share_hasid(Semester::LAST.id)%>">
							 <%=fa_icon "clipboard"%>
					</button>
					<% end %>
				</h4>		
			</div>
			<table class="table table-bordered" id="schedule_table"></table>
		</div>	
	</div>
	
</div>
<ol id="joyRideTipContent">
	<li data-text="Next" class="">
		<h2>Tips</h2>
		<p>
		請使用Enter鍵或滑鼠點擊灰色處觀看	
		</p>
	</li>
	<li data-id="shopping-cart" data-button="Next">
		<h4>收藏課程</h4>
		<p>點此察看在「全校課程」中收藏的課程</p>
	</li>
	<li data-class="btn-success" data-button="Next">
		<h4>匯出課表</h4>
		<p>匯出Excel格式或圖檔</p>
	</li>
	<li data-id="sel-time-btn" data-button="Next">
		<h4>推薦-空堂</h4>
		<p>
			先在右方的課表空格中選擇時間<br>
			按下按鈕搜尋該時段的「通識及外文」課程<br>
			可以搜尋很多個時段喔!
		</p>
	</li>
	<li data-id="dimension-btn" data-button="Next">
		<h4>推薦-向度</h4>
		<p>推薦目前缺少的通識向度(需先匯入成績)</p>
	</li>
</ol>
	
<script>
	$(document).ready(function(){
		toastr["success"]("已更新到104上的課程囉!!!");
		$(".pop-over").popover({
				trigger :"hover",
				container :"body",
				placement : "auto"
		});
		showHasSelected();

		//course table
		load_course_table(<%=Semester::LAST.id%>, true);
		//sessionTest();
		$('#joyRideTipContent').joyride({
      autoStart : true,
      cookieMonster: true,           
      cookieName: 'CourseSimulationTip', 
      modal:true,
      expose: true
    });
<% if current_user.canShare? %>	
    new ZeroClipboard( $('#copy-it-simu') );	
		$('#copy-it-simu').popover({
      placement:"bottom",
      trigger :"hover",
      container :"body"
		}).click(function(){toastr["success"]('已複製到剪貼簿');});
<% end %>		
	});

	function load_course_table(semester_id, selectable){
		$.getJSON("/user/get_courses?type=course_table&sem_id="+semester_id,function(data){
			//console.log(data);
			data.config = {
				deletable: true ,
				selectable: true,
				popover: true,
				semester_id: semester_id,
				cancelButtonFunc: function(arg){
					var cd_id = arg.data.cd_id;
					save_course(cd_id,'delete','load_course_table');
				}
			};
			$('#schedule_table').CourseTable(data);	
			$('#schedule_table').CourseTable("renderImg","upload");
		});
	}
	
	function showHasSelected(){
		$.getJSON("/user/get_courses?type=simulation",function(data){
			//console.log(data);
			$(".scrollable").html(tmpl("search_result", data));
		});
	}

</script>

<%=render "courses/search/search_js"%>
<%=render "courses/search/xtmpl_results_mini"%>

<style>
.header-button{
  margin-top: -5px ;
}
</style>
