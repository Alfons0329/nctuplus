<%= javascript_include_tag "course_maps/public", "data-turbolinks-track" => true %>


<div class="row" style="min-height:1000px;height:100%;">
	<div class="col-sm-3 col-md-2 affix-sidebar sidebar-nav" style="margin-top:-30px;margin-left:-5px;width:250px;height:100%;/*min-height:100%;*/">
		<%=render "course_maps/public/dept_sidebar"%>
	</div>
	</div>
	<div id="tip-test"></div>
	
	<div id="central-view" class="col-md-10" style="margin-left:300px;">
		<div class="panel panel-default">
			<div class="panel-body" id="cm-desc" style="margin-left:5.4%;margin-right:2.4%;">
				<% if params[:dept_id].blank? %>
				<h4><b>請先至左方選擇系或由搜尋欄查詢</b><br></h4><br>
				<div class="search" style="width:30%">
				<form action="#" class="search" method="get" id="searchform" >
				　科系： <select name="Department">
				　<option value="id1" >資工系 網多組</option>
				　<option value="id2">資工系 資電組</option>
				　<option value="id3">資工系 資工組</option>
				　<option value="id4">資科工所</option>
				  </select><br>
				　年級： <select name="Grade">
				　<option value="UnderGraduate1">一年級</option>
				　<option value="UnderGraduate2">二年級</option>
				　<option value="UnderGraduate3">三年級</option>
				　<option value="UnderGraduate4">四年級</option>
				  <option value="Graduate1">碩一</option>
				　<option value="Graduate2">碩二</option>
				  </select><button class="btn btn-primary" type="submit" form="searchform" value="Submit"
				style="margin-left:100%;"
				>送出</button>
				</form>
				
				
				</div>
				<% end %>
			</div>
			<div class="panel-body" id="cm-desc">
			
			</div>
			<div id="QandA" style="display: none;">
			</div>
		</div>
	</div>
	
	<div class="col-md-2">
		<div class="scroll-sidebar hidden-xs hidden-sm" style="font-size:16px;position:fixed;margin-top:40px;"></div>
	</div>
	<ol id="joyRideTipContent">
		<li data-text="Next" class="">
			<h2>Tips</h2>
			<p>
			請使用Enter鍵或滑鼠點擊灰色處觀看	
			</p>
		</li>
		
		<li data-id="year-selector" data-button="Next">
			<h4>選取入學年度</h4>
			<p></p>
		</li>
		<li data-id="rules" data-button="Next" data-options="tipLocation:right">
			<h2>修課規定</h2>
			<p>至少需修0學分通常為該領域的其他選修即可滿足該領域的條件，若非上述情形則請回報</p>			
		</li>
		<li data-id="course-table" data-button="Next" data-options="tipLocation:right">
			<h2>課程列表</h2>
			<p>藍底色的列為可互相抵免的課程列表，可按左邊的+展開</p>
		</li>
		<li data-text="Next" class="">
			<h2>We need help!</h2>
			<p>
			此頁面是由團隊成員將學校的<a href="http://aadm.nctu.edu.tw/chcourse/class03.aspx?ftype=3">必修科目表</a>手動輸入至系統，若有錯誤請至下方Q&A區回報，我們將會儘快處理<br>
			我們正與一些系洽談中，之後希望由系助理來協助輸入，若同學願意擔任該系管理員請至粉專私訊 :)<br>
			目前可以幫同學計算列表上的必修/必選修等課程，但<strong>系外選修</strong>、<strong>任選理工科目</strong>、<strong>英文授課</strong>等較特殊的規則目前無法計算<br>			
			</p>
		</li>
		
  </ol>
	
</div>
<script>
	
	
	function show_tip(){
		
		$('#joyRideTipContent').joyride("destroy");
		$('#joyRideTipContent').joyride({
			autoStart : true,
			cookieMonster: false
		});
	}
	function load_cm(dept_id,year){		
		$.getJSON("/course_maps/public",{
			dept_id: dept_id,
			year: year
			},
			function(data){
				console.log(data);
				$("#cm-desc").html(tmpl("cm_public", data));//tmpl 插件
				$("#year-"+year).addClass("disabled");
				
				//$("#sem-btn").click();
				
				get_piechart_data("#chart-content", data.course_map);
				if(!isMobile){
					/*$(".scroll-sidebar").html(tmpl("cf_scrolllist", data),function(){
						$('body').scrollspy({ target: '.scroll-sidebar',offset:-60 });						
					});
					$('body').scrollspy('refresh');
					$('.main-menu li a').click(function(event) {
							event.preventDefault();
							$('body').scrollTo($(this).attr('href'),700,{offset:-60});
					});*/
				}
				
				$('#joyRideTipContent').joyride({
					autoStart : true,
					cookieMonster: true,           
					cookieName: 'CourseMapPublicTip', 
					postStepCallback : function (index, tip) {
						if (index == 2) {
							$(".toggle-group:visible")[0].click();
						}						
					},
					modal:true,
					expose: true
					
				});
				/* QandA
				$('#QandA').show();
				$("#QandA").html(tmpl("cm_public_comments", {"comments": data.course_map.comments, "cm_id": data.course_map.id}));
				*/
				show_course();
				//count_course();
			}
		);
	}
	$(document).ready(function(){
		//show_course();
		var dept_id=<%=params[:dept_id]||0%>;
		var year=<%=params[:year]||0%>;
		if(dept_id!=0){
			$("#dept-"+dept_id).parent().parent().prev().click();		
			$("#dept-"+dept_id).addClass("selected");
			if(year!=0){
				load_cm(dept_id,year);	
			}
		}
	
	});

	function load_qa(dept_id,sem_id){
		var qa_div = $('#QandA').children().first() ;
		$('#QandA').show();
		
	}
	function show_course(){
		var colors=["#0066CC","#F00078","#F75000","#5A5AAD","#804040",
								"#408080","	#64A600","#336666"];
		
		console.log($(".btn-course")[0]);
		$( ".btn-course" ).mouseover(function(event)
		{
			var course=JSON.parse($(this).attr('data'));
			var offset = $( this ).offset();
			var id1 = $(this).attr('id');
			
			var color4 = $(this).css('background-color');
			
			var str="#"+id1;
			var content = "永久課號 : "+course.real_id;
			var sty=("2px "+ $(str).css("background")+" solid");
				
				$( ".tooltip-course" ).css({
					"left": (event.pageX-320),
					"top": (event.pageY-35),
					"display": "block"});
					
				
				var group = "";
				var content2;
				var i = 0;
				
				content2 = "學分數 : " + course.credit + "<br>" + "選課別 : " + 
										course.cf.cf_name + "<br>";
				if(course.cg_courses)
				{
					content2 = content2 + "互抵課程 : "+"<br>"
					while(course.cg_courses[i])
					{
						group = course.cg_courses[i].name;
						group_course_id = course.cg_courses[i].real_id;
						content2 = content2 + "<b>" + group + "(課號 : " +
											group_course_id  + ")" + "</b>" + "<br>";
						i++;
					}
				}
				
					$( ".course-name" ).html(course.name+"<br>"+content).css("background",color4);
					$( ".course-content" ).html(content2);
					$( ".tooltip-course" ).css("border-color",color4);
			})
				.mousemove(function(event){
					var color4 = $(this).css('background-color');
					
					var id1 = $(this).attr('id');
					var color1="#FF0080";
					var str="#"+id1;
					var sty=("2px "+$(str).css("background")+" solid");
					var w = $( window ).width();
					
					if(w < 1266)w = 0;
					else w = (w - 1266)*1266/w;
					
					$( ".tooltip-course" ).css({
						"left": (event.pageX-306-w),
						"top": (event.pageY-70),
						"display": "block",
						"border-color":(color4)
					});
					$( ".course-name" ).css({
						"background-color":$(str).css("background-color")});
					$( ".tooltip-course" ).css("border-color",color4);
					
				})
				.mouseout(function(event){
					
					var id1 = $(this).attr('id');
					var color1="#FF0080";
						
					$( ".tooltip-course" ).css({
						"display": "none",
						});
				});
			$( ".tooltip-course" ).mouseover(function(){
				$( this ).css({"display": "block"});})
			.mousemove(function(event){
					$( this ).css({"display": "block"});
			})
			.mouseout(function(event){
				$( this).css({"display": "none"});
			});
	}
	
	function count_course()
	{
		var courses_grade = JSON.parse($("table").attr('data'));
		var category = [];
		var count1 = 0;
		var exist = 0;
		for(var i=0,courses;courses=courses_grade[i];i++)
			for(var j=0,course;course=courses[j];j++)
			{
				for(var k=0; k < category.length;k++)
				{
					if(course.cf.cf_name == category[k] )
					{
						exist = 1;
						break;
					}
				}
				if(exist==0)category.push(course.cf.cf_name);
				else exist = 0;
			}	
			alert(category[2]);
	}
	
	function genCfTree(cf){
		
		str='<li class="cf-li"><a href="#'+cf.id+'">'+cf.cf_name+'</a></li>';
		if(cf.cf_type==3){
			str+='<ul class="nav sub-sub-menu">';
			for(var i=0,child_cf;child_cf=cf.child_cf[i];i++){
				str+=genCfTree(child_cf);
			}
			str+='</ul>'
		}
		return str;
	}
	
	function toggleGroup(obj,cf_id,id){
		var target=$(".cf-"+cf_id+"-"+id);
		target.toggle(600,function(){
			if(target.is(":visible")){
				obj.find(".fa-plus").toggleClass("fa-minus fa-plus");
			}
			else{
				obj.find(".fa-minus").toggleClass("fa-minus fa-plus");
			}
		});
		
	}
	function toggleBtn(obj){
		var x=obj.attr('type');
		if(x=="show"){
			obj.text("收回課程群組");
			$("[class*=cf-]").show();
			obj.attr('type','hide');
			$(".fa-plus").attr("class","fa fa-minus");
		}
		else{
			obj.text("展開課程群組");
			$("[class*=cf-]").hide();
			obj.attr('type','show');
			$(".fa-minus").attr("class","fa fa-plus");
		}
	}
	
	
	
</script>

<!--<%= render "/course_maps/public/xtmpl_scrollbar" %>-->
<%= render "/course_maps/public/xtmpl_course_table" %>
<%= render "/course_maps/public/xtmpl_qa" %>

<style>
	.tooltip-course
	{
		background:#fff;
		border:1px #ccc solid;
		border-radius:6px;
		position:absolute;
		left:300px;
		top:300px;
		width:auto;
		height:auto;
		padding-bottom:5px;
		display:none;
		z-index:1000;
		
		-webkit-box-shadow: 3px 3px 20px -3px rgba(0,0,0,0.75);
		-moz-box-shadow: 3px 3px 20px -3px rgba(0,0,0,0.75);
		box-shadow: 3px 3px 20px -3px rgba(0,0,0,0.75);
	}
	.course-name
	{
		overflow:hidden;
		background:#aaa;
		
		color:white;
		padding:5px 5px;
	}
	.course-content
	{
		
		color:#555;
		padding:5px 5px;
		overflow:hidden;
		display:block;
		
	}
	.widget-course
	{
		height:80px;
		width:160px;
		margin-bottom:20px;
		
		float:right;
		display:block;
	}
	
	.square-course
	{
		width:12px;
		height:12px;
		background:#666;
		display:inline-block;
		margin-left:15px;
		margin-top:10px;
		line-height:20px;
	}
	.widget-line
	{
		line-height:20px;
	}
	.lead_course {
		border-bottom: 3px solid #ddd;
		-moz-box-shadow:    inset 0 0 10px #000000;
	  -webkit-box-shadow: inset 0 0 10px #000000;
	  box-shadow:         inset 0 0 10px #000000;
	}
	.grade1
	{
		background:#333;
		color:white;
		
	}
	.grade2
	{
		border-left: 5px solid #ddd;
	}
	.semester1
	{
		background:#ccc
	}
	.semester2
	{
		background:#ccc;
		border-left: 2px solid #fff;
	}
	.btn-course
	{
		padding:4px 8px;
		margin:10px 0px;
		color:#fff;
		border-radius:4px;
		font-size:12px;
		text-align:center;
		height:42px;
		background:#0080FF;
	}
	.btn-course:hover
	{
		opacity:0.8;
	}
	#btn-course-required
	{
		background:#0080FF;
	}
	#btn-course-minor
	{
		background:#FF8040;
	}
	#btn-course-main
	{
		background:#FF0080;
	}
	
	#table-gray-line
	{
		border-left:1px #aaa solid;
	}
	#table-not-limit
	{
		height:0px;
		background:#ccc;
	}
	/*html, body{height:100%;}*/

</style>